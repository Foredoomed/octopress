
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>iBatis和myBatis源码分析之缓存 - Zhixingheyi</title>
  <meta name="author" content="Foredoomed">

  
  <meta name="description" content="一.iBatis 1.iBatis的cache包结构： Packages com.ibatis.sqlmap.engine.cache
&nbsp; com.ibatis.sqlmap.engine.cache.fifo
&nbsp; com.ibatis.sqlmap.engine.cache. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://liuxuan.info/blog/2011/09/16/ibatis-and-mybatis-source-code-analysis-cache/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/zhixingheyi" rel="alternate" title="Zhixingheyi" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17293168-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Zhixingheyi</a></h1>
  
    <h2>Just for fun!</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/zhixingheyi" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:liuxuan.info" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">iBatis和myBatis源码分析之缓存</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-16T18:41:00+08:00" pubdate data-updated="true">Sep 16<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>一.iBatis</strong></p>

<p>1.iBatis的cache包结构：</p>

<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<tr>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b>
</th>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.fifo</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.lru</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.memory</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>com.ibatis.sqlmap.engine.cache.oscache</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>

<p>iBatis已实现的四个CacheController类分别是：</p>

<ul>
  <li>FifoCacheController</li>
  <li>LruCacheController</li>
  <li>MemoryCacheController</li>
  <li>OSCacheController</li>
</ul>

<p>其中，前三种是最常用的缓存策略，第四种是对<a href="http://java.net/projects/oscache" title="OSCache">OSCache</a>的支持。当然，你也可以根据需要实现自己的缓存策略，只需要实现CacheController接口就可以了。 <!--more--></p>

<p>2.源码分析</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>FifoCacheController.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * FIFO (first in, first out) cache controller implementation</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FifoCacheController</span> <span class="kd">implements</span> <span class="n">CacheController</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">int</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span> <span class="n">cache</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">List</span> <span class="n">keyList</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Default constructor</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">FifoCacheController</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cacheSize</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cache</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">());</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">keyList</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCacheSize</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCacheSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">cacheSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cacheSize</span> <span class="o">=</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Configures the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param props Optionally can contain properties [reference-type=WEAK|SOFT|STRONG]</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="n">Properties</span> <span class="n">props</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;cache-size&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">cacheSize</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Add an object to the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cacheModel</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be cached</span>
</span><span class="line"><span class="cm">   * @param value      The object to be cached</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">keyList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">cacheSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Object</span> <span class="n">oldestKey</span> <span class="o">=</span> <span class="n">keyList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class="line">        <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">oldestKey</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IndexOutOfBoundsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="c1">//ignore</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Get an object out of the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be returned</span>
</span><span class="line"><span class="cm">   * @return The cached object (or null)</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Flushes the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们可以看到FifoCacheController是用一个同步的HashMap和一个同步的LinkedList来实现的。其中，HashMap用来保存缓存内容；LinkedList是用来保存缓存中的对象的key。本来缓存只需要一个key-value容器就可以实现了，为什么要多引入一个LinkedList呢？主要原因还是Map的API不够强大，不支持索引操作，为了方便地找到HashMap中的第一个元素就必须加入一个支持索引的操作的集合，比如FifoCacheController类里的LinkedList,这样就可以快速地找到HashMap中的第一个对象的key值，而不是迭代HashMap。</p>

<p>但是，这样的实现存在一个bug。假设有下列代码：</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">putObject</span><span class="o">(</span><span class="n">cacheModel1</span><span class="o">,</span> <span class="s">&quot;key1&quot;</span><span class="o">,</span> <span class="s">&quot;value1&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">putObject</span><span class="o">(</span><span class="n">cacheModel2</span><span class="o">,</span> <span class="s">&quot;key2&quot;</span><span class="o">,</span> <span class="s">&quot;value2&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">putObject</span><span class="o">(</span><span class="n">cacheModel3</span><span class="o">,</span> <span class="s">&quot;key1&quot;</span><span class="o">,</span> <span class="s">&quot;value3&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>显然，这个时候HashMap中应该有两个值，”key1”-&gt;”value3”和”key2”-&gt;”value2”；但是HashMap中却有三个key值，这样HashMap和LinkedList无法对应起来，也就是bug产生的原因。这个bug只存在与iBatis中，myBatis已经重写了缓存的实现，所以myBatis没有这个bug。</p>

<p>在putObject方法里，又出现了在catch体里不做任何处理的“坏味道”。而且我们知道在这里捕获的IndexOutOfBoundsException不是已检查异常，完全可以不加try-catch；如果要加上try-catch的话，那么在catch体里可以加上日志，这样对缓存调优是非常有帮助的；又或者可以把异常抛出，在CacheModel类里处理异常。总之，异常处理是一定要做的，绝对不能什么都不做。</p>

<p>从实际情况来看，FIFO策略的缓存实现很少使用，用到最多的还是LRU策略的缓存实现。我们来看一下iBatis的LRU缓存实现：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>LruCacheController.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * LRU (least recently used) cache controller implementation</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LruCacheController</span> <span class="kd">implements</span> <span class="n">CacheController</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">int</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span> <span class="n">cache</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">List</span> <span class="n">keyList</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Default constructor</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">LruCacheController</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cacheSize</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cache</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">());</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">keyList</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCacheSize</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCacheSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">cacheSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">cacheSize</span> <span class="o">=</span> <span class="n">cacheSize</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Configures the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param props Optionally can contain properties [reference-type=WEAK|SOFT|STRONG]</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="n">Properties</span> <span class="n">props</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;cache-size&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">size</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;size&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">cacheSize</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Add an object to the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cacheModel</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be cached</span>
</span><span class="line"><span class="cm">   * @param value      The object to be cached</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">keyList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">cacheSize</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Object</span> <span class="n">oldestKey</span> <span class="o">=</span> <span class="n">keyList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class="line">        <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">oldestKey</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IndexOutOfBoundsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="c1">//ignore</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Get an object out of the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be returned</span>
</span><span class="line"><span class="cm">   * @return The cached object (or null)</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">keyList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Flushes the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">    <span class="n">keyList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>LruCacheController怎么跟FIFOCacheController长得差不多啊，FIFO跟LRU的区别在哪里体现呢？LRU就是当缓存空间不足时，把最近最少使用的对象移除，那怎么说明一个对象是最近最少使用呢？再仔细一看，答案就在getObject方法里。当要在缓存中取对象时，先删除keyList中对应的key值，然后再加入到keyList的末尾，这样keyList中按顺序越是靠前的对象越是最近最少使用的对象。LruCacheController要依靠keyList实现LRU，所以FIFO里的两个集合不同步的bug在LRU里依然存在。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>MemoryCacheController.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Memory-based implementation of CacheController</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemoryCacheController</span> <span class="kd">implements</span> <span class="n">CacheController</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">MemoryCacheLevel</span> <span class="n">referenceType</span> <span class="o">=</span> <span class="n">MemoryCacheLevel</span><span class="o">.</span><span class="na">WEAK</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Configures the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param props Optionally can contain properties [reference-type=WEAK|SOFT|STRONG]</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProperties</span><span class="o">(</span><span class="n">Properties</span> <span class="n">props</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">refType</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;reference-type&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">refType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">refType</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;referenceType&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">refType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">referenceType</span> <span class="o">=</span> <span class="n">MemoryCacheLevel</span><span class="o">.</span><span class="na">getByReferenceType</span><span class="o">(</span><span class="n">refType</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">MemoryCacheLevel</span> <span class="nf">getReferenceType</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">referenceType</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReferenceType</span><span class="o">(</span><span class="n">MemoryCacheLevel</span> <span class="n">referenceType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">referenceType</span> <span class="o">=</span> <span class="n">referenceType</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Add an object to the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cacheModel</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be cached</span>
</span><span class="line"><span class="cm">   * @param value      The object to be cached</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">reference</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">referenceType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">MemoryCacheLevel</span><span class="o">.</span><span class="na">WEAK</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">      <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">referenceType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">MemoryCacheLevel</span><span class="o">.</span><span class="na">SOFT</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">      <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SoftReference</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">referenceType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">MemoryCacheLevel</span><span class="o">.</span><span class="na">STRONG</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">      <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StrongReference</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">reference</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Get an object out of the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   * @param key        The key of the object to be returned</span>
</span><span class="line"><span class="cm">   * @return The cached object (or null)</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">StrongReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">StrongReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">SoftReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">SoftReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">WeakReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">WeakReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">StrongReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">StrongReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">SoftReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">SoftReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">WeakReference</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">value</span> <span class="o">=</span> <span class="o">((</span><span class="n">WeakReference</span><span class="o">)</span> <span class="n">ref</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Flushes the cache.</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param cacheModel The cache model</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">flush</span><span class="o">(</span><span class="n">CacheModel</span> <span class="n">cacheModel</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">cache</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Class to implement a strong (permanent) reference.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StrongReference</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">object</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/**</span>
</span><span class="line"><span class="cm">     * StrongReference constructor for an object</span>
</span><span class="line"><span class="cm">     * @param object - the Object to store</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="kd">public</span> <span class="nf">StrongReference</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">this</span><span class="o">.</span><span class="na">object</span> <span class="o">=</span> <span class="n">object</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/**</span>
</span><span class="line"><span class="cm">     * Getter to get the object stored in the StrongReference</span>
</span><span class="line"><span class="cm">     * @return - the stored Object</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">      <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>基于内存的MemoryCacheController用到了MemoryCacheLevel这个类。在MemoryCacheLevel中定义了三种对象的引用类型：strong，soft和weak。关于Java的引用类型，可以参考我在我以前写的一篇博文<a href="http://liuxuan.info/2011/03/java-four-types-of-reference/" title="Java的四种引用类型">Java的四种引用类型</a>。总的来说，MemoryCacheController的实现还是比较简单的，但要注意到MemoryCacheController里没有keyList，所以不存在FIFO和LRU中都有的那个两个集合不同步的bug。</p>

<p>了解了缓存的实现之后，我们还要要搞清楚iBatis是什么时候把对象放到缓存中去的。其实根据常识，对象肯定是在第一次被从数据库中读取出来的时候存放到缓存中去的，接下去就来验证我们的猜想。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>CachingStatement.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">public</span> <span class="n">CacheKey</span> <span class="nf">getCacheKey</span><span class="o">(</span><span class="n">StatementScope</span> <span class="n">statementScope</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameterObject</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">CacheKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">getCacheKey</span><span class="o">(</span><span class="n">statementScope</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">cacheModel</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cacheModel</span><span class="o">.</span><span class="na">isSerialize</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">      <span class="n">key</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">statementScope</span><span class="o">.</span><span class="na">getSession</span><span class="o">());</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">executeQueryForObject</span><span class="o">(</span><span class="n">StatementScope</span> <span class="n">statementScope</span><span class="o">,</span> <span class="n">Transaction</span> <span class="n">trans</span><span class="o">,</span>
</span><span class="line">  	<span class="n">Object</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">Object</span> <span class="n">resultObject</span><span class="o">)</span><span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span><span class="line">  	
</span><span class="line">    <span class="n">CacheKey</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">statementScope</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">);</span>
</span><span class="line">    <span class="n">cacheKey</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;executeQueryForObject&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">cacheModel</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="n">CacheModel</span><span class="o">.</span><span class="na">NULL_OBJECT</span><span class="o">){</span>
</span><span class="line">    	<span class="c1">//	This was cached, but null</span>
</span><span class="line">    	<span class="n">object</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">       <span class="n">object</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQueryForObject</span><span class="o">(</span><span class="n">statementScope</span><span class="o">,</span> <span class="n">trans</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">resultObject</span><span class="o">);</span>
</span><span class="line">       <span class="n">cacheModel</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">List</span> <span class="nf">executeQueryForList</span><span class="o">(</span><span class="n">StatementScope</span> <span class="n">statementScope</span><span class="o">,</span> <span class="n">Transaction</span> <span class="n">trans</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameterObject</span><span class="o">,</span>
</span><span class="line">  	<span class="kt">int</span> <span class="n">skipResults</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxResults</span><span class="o">)</span><span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span><span class="line">  	
</span><span class="line">    <span class="n">CacheKey</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">statementScope</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">);</span>
</span><span class="line">    <span class="n">cacheKey</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;executeQueryForList&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">cacheKey</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">skipResults</span><span class="o">);</span>
</span><span class="line">    <span class="n">cacheKey</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">maxResults</span><span class="o">);</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">listAsObject</span> <span class="o">=</span> <span class="n">cacheModel</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">);</span>
</span><span class="line">    <span class="n">List</span> <span class="n">list</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span><span class="o">(</span><span class="n">listAsObject</span> <span class="o">==</span> <span class="n">CacheModel</span><span class="o">.</span><span class="na">NULL_OBJECT</span><span class="o">){</span>
</span><span class="line">      <span class="c1">// The cached object was null</span>
</span><span class="line">      <span class="n">list</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">listAsObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">list</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQueryForList</span><span class="o">(</span><span class="n">statementScope</span><span class="o">,</span> <span class="n">trans</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">skipResults</span><span class="o">,</span> <span class="n">maxResults</span><span class="o">);</span>
</span><span class="line">      <span class="n">cacheModel</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span><span class="line">      <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span> <span class="n">listAsObject</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们可以看到，在executeQueryForObject和executeQueryForList方法中，首先根据对象的key值到缓存中获取对象，如果没有找到对应的对象就通过调用下面的方法来把对象存放到缓存中：</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">cacheModel</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这样我们之前的猜想就得到了验证。我们再来看看缓存中对象对应的key是什么东西，定位到CacheModel类的putObject方法：</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">private</span> <span class="n">CacheController</span> <span class="n">controller</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"> <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Add an object to the cache</span>
</span><span class="line"><span class="cm">   *</span>
</span><span class="line"><span class="cm">   * @param key   The key of the object to be cached</span>
</span><span class="line"><span class="cm">   * @param value The object to be cached</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">CacheKey</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  	<span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">value</span><span class="o">)</span> <span class="n">value</span> <span class="o">=</span> <span class="n">NULL_OBJECT</span><span class="o">;</span>
</span><span class="line">  	<span class="kd">synchronized</span> <span class="o">(</span> <span class="k">this</span> <span class="o">)</span>  <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">serialize</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">readOnly</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">NULL_OBJECT</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span><span class="line">          <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
</span><span class="line">          <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span><span class="line">          <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
</span><span class="line">          <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class="line">          <span class="n">value</span> <span class="o">=</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Error caching serializable object.  Cause: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">controller</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span> <span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">()</span> <span class="o">)</span>  <span class="o">{</span>
</span><span class="line">        <span class="n">log</span><span class="o">(</span><span class="s">&quot;stored object&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>CacheModel类里的putObject方法又调用了CacheController的putObject方法，注意传入的key值是CacheKey对象，也就是说最后作为缓存中对象的key是它的CacheKey对象。不得不说这是一个失败的设计，key值的类型是String类型就已经足够了，完全没有必要用对象类型来做key值的类型。因为内存空间是有限的，要在有限的空间中尽可能地存放更多的内容，就需要key值在保证唯一性的情况下空间占的越小越好。</p>

<p><strong>二.myBatis</strong></p>

<p>1.myBatis的cache包结构：</p>

<table border="1" width="100%" cellpadding="3" cellspacing="0" summary="">
<tbody>
<tr>
<th align="left" colspan="2" style="background-color:#CCCCFF">
<b>Packages</b>
</th>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache.decorators</b></td>
<td>&nbsp;</td>
</tr>
<tr bgcolor="white">
<td width="20%"><b>org.apache.ibatis.cache.impl</b></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>

<p>相比iBatis来说，myBatis的包结构变得更简洁，从五个包简化成了三个包。而且从实现方式上也有了改变，从decorators这样的包名可以猜到在这个包下的类都是装饰类，而实际上也是如此的。myBatis的缓存实现采用了装饰模式，impl包下实现的是缓存的基本功能，不同的缓存策略由decorators包下的类实现。</p>

<p>相比iBatis，myBatis增加了多个缓存实现：</p>

<ul>
  <li>LoggingCache</li>
  <li>ScheduledCache</li>
  <li>SerializedCache</li>
  <li>SynchronizedCache</li>
  <li>TransactionalCache</li>
</ul>

<p>2.源码分析</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Cache.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Cache</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">String</span> <span class="nf">getId</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="kt">int</span> <span class="nf">getSize</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="kt">void</span> <span class="nf">clear</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="n">ReadWriteLock</span> <span class="nf">getReadWriteLock</span><span class="o">();</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>和iBatis不同，Cache接口中定义了concurrent包中的ReadWriteLock接口，而它只有一个实现类ReentrantReadWriteLock。对比iBatis使用同步的Map集合来解决解决并发读写时缓存数据的同步问题，myBatis则使用ReentrantReadWriteLock类的锁机制来防止在并发写过程中的线程安全问题。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>LruCache.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Lru (first in, first out) cache decorator</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LruCache</span> <span class="kd">implements</span> <span class="n">Cache</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Cache</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">object</span> <span class="o">,</span> <span class="n">Object</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">keyMap</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Object</span> <span class="n">eldestKey</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">LruCache</span><span class="o">(</span><span class="n">Cache</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class="line">    <span class="n">setSize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSize</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">getSize</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSize</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">keyMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">object</span> <span class="o">,</span> <span class="n">Object</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;(</span><span class="n">size</span><span class="o">,</span> <span class="o">.</span><span class="mi">75</span><span class="n">F</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">4267176411845948333L</span><span class="o">;</span>
</span><span class="line">      <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">removeEldestEntry</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">object</span> <span class="o">,</span> <span class="n">Object</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">eldest</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">boolean</span> <span class="n">tooBig</span> <span class="o">=</span> <span class="n">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">tooBig</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">          <span class="n">eldestKey</span> <span class="o">=</span> <span class="n">eldest</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="k">return</span> <span class="n">tooBig</span><span class="o">;</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">};</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">delegate</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">    <span class="n">cycleKeyList</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">keyMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span> <span class="c1">//touch</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">removeObject</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">delegate</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">    <span class="n">keyMap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">ReadWriteLock</span> <span class="nf">getReadWriteLock</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">getReadWriteLock</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">cycleKeyList</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">keyMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">eldestKey</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">delegate</span><span class="o">.</span><span class="na">removeObject</span><span class="o">(</span><span class="n">eldestKey</span><span class="o">);</span>
</span><span class="line">      <span class="n">eldestKey</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>LRU是最常使用的缓存算法，所以就以LruCache为例，其他缓存实现也是差不多的。在iBatis里，key值是用一个同步的LinkedList来维护的，而myBatis则是改用LinkedHashMap来维护。这样做的好处就是解决了在iBatis中的HashMap和LinkedList的不同步问题，而且也不需要自己实现LRU，LinkedHashMap原生就支持LRU。</p>

<p>缓存中的对象是存放在impl包下的PerpetualCache类的HashMap里的，所以各个缓存算法实现类里都需要持有一个PerpetualCache实例。当要从缓存中读取数据时，就委托给PerpetualCache类去执行读取方法，而这对于调用者来说是透明的。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>DefaultSqlSession.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">private</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">dirty</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">DefaultSqlSession</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">configuration</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">executor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">autoCommit</span> <span class="o">=</span> <span class="n">autoCommit</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">dirty</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">List</span> <span class="nf">selectList</span><span class="o">(</span><span class="n">String</span> <span class="n">statement</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">MappedStatement</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getMappedStatement</span><span class="o">(</span><span class="n">statement</span><span class="o">);</span>
</span><span class="line">      <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">wrapCollection</span><span class="o">(</span><span class="n">parameter</span><span class="o">),</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">Executor</span><span class="o">.</span><span class="na">NO_RESULT_HANDLER</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">throw</span> <span class="n">ExceptionFactory</span><span class="o">.</span><span class="na">wrapException</span><span class="o">(</span><span class="s">&quot;Error querying database.  Cause: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">      <span class="n">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>DefaultSqlSession在创建完成后就有了对应的Executor实例，查询就调用Executor实例的query方法。那DefaultSqlSession是在哪里被创建的呢？</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>DefaultSqlSessionFactory.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">SqlSession</span> <span class="nf">openSessionFromDataSource</span><span class="o">(</span><span class="n">ExecutorType</span> <span class="n">execType</span><span class="o">,</span> <span class="n">TransactionIsolationLevel</span> <span class="n">level</span><span class="o">,</span>   <span class="kt">boolean</span> <span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="kd">final</span> <span class="n">Environment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">();</span>
</span><span class="line">      <span class="kd">final</span> <span class="n">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">getDataSourceFromEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
</span><span class="line">      <span class="n">TransactionFactory</span> <span class="n">transactionFactory</span> <span class="o">=</span> <span class="n">getTransactionFactoryFromEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
</span><span class="line">      <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">level</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">connection</span><span class="o">.</span><span class="na">setTransactionIsolation</span><span class="o">(</span><span class="n">level</span><span class="o">.</span><span class="na">getLevel</span><span class="o">());</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">connection</span> <span class="o">=</span> <span class="n">wrapConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</span><span class="line">      <span class="n">Transaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">transactionFactory</span><span class="o">.</span><span class="na">newTransaction</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">);</span>
</span><span class="line">      <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">newExecutor</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">execType</span><span class="o">);</span>
</span><span class="line">      <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultSqlSession</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">autoCommit</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">closeConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</span><span class="line">      <span class="k">throw</span> <span class="n">ExceptionFactory</span><span class="o">.</span><span class="na">wrapException</span><span class="o">(</span><span class="s">&quot;Error opening session.  Cause: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">      <span class="n">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以看到DefaultSqlSession是在打开session时创建的，而且在创建DefaultSqlSession之前，通过调用了Configuration类的newExecutor方法创建相应的Executor实例。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Configuration.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">public</span> <span class="n">Executor</span> <span class="nf">newExecutor</span><span class="o">(</span><span class="n">Transaction</span> <span class="n">transaction</span><span class="o">,</span> <span class="n">ExecutorType</span> <span class="n">executorType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">executorType</span> <span class="o">=</span> <span class="n">executorType</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">defaultExecutorType</span> <span class="o">:</span> <span class="n">executorType</span><span class="o">;</span>
</span><span class="line">    <span class="n">executorType</span> <span class="o">=</span> <span class="n">executorType</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">ExecutorType</span><span class="o">.</span><span class="na">SIMPLE</span> <span class="o">:</span> <span class="n">executorType</span><span class="o">;</span>
</span><span class="line">    <span class="n">Executor</span> <span class="n">executor</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">ExecutorType</span><span class="o">.</span><span class="na">BATCH</span> <span class="o">==</span> <span class="n">executorType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatchExecutor</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">transaction</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ExecutorType</span><span class="o">.</span><span class="na">REUSE</span> <span class="o">==</span> <span class="n">executorType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReuseExecutor</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">transaction</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleExecutor</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">transaction</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">cacheEnabled</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachingExecutor</span><span class="o">(</span><span class="n">executor</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">executor</span> <span class="o">=</span> <span class="o">(</span><span class="n">Executor</span><span class="o">)</span> <span class="n">interceptorChain</span><span class="o">.</span><span class="na">pluginAll</span><span class="o">(</span><span class="n">executor</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>代码还是比较清晰地，通过读取配置文件里的内容来创建Executor实例。到这里为止，在DefaultSqlSession创建完成后就会持有相应的Executor实例，如果是配置了缓存，那么将会创建CachingExecutor。而且CachingExecutor类里将会持有下列Executor的其中一种：BatchExecutor，ReuseExecutor和SimpleExecutor。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>CachingExecutor.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachingExecutor</span> <span class="kd">implements</span> <span class="n">Executor</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">Executor</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">TransactionalCacheManager</span> <span class="n">tcm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionalCacheManager</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">CachingExecutor</span><span class="o">(</span><span class="n">Executor</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">List</span> <span class="nf">query</span><span class="o">(</span><span class="n">MappedStatement</span> <span class="n">ms</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">ResultHandler</span> <span class="n">resultHandler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">ms</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="na">getCache</span><span class="o">();</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">flushCacheIfRequired</span><span class="o">(</span><span class="n">ms</span><span class="o">);</span>
</span><span class="line">        <span class="n">cache</span><span class="o">.</span><span class="na">getReadWriteLock</span><span class="o">().</span><span class="na">readLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="k">if</span> <span class="o">(</span><span class="n">ms</span><span class="o">.</span><span class="na">isUseCache</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">resultHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">CacheKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">createCacheKey</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">);</span>
</span><span class="line">            <span class="kd">final</span> <span class="n">List</span> <span class="n">cachedList</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span> <span class="n">cache</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">cachedList</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">              <span class="k">return</span> <span class="n">cachedList</span><span class="o">;</span>
</span><span class="line">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">              <span class="n">List</span> <span class="n">list</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">resultHandler</span><span class="o">);</span>
</span><span class="line">              <span class="n">tcm</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
</span><span class="line">              <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">            <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">resultHandler</span><span class="o">);</span>
</span><span class="line">          <span class="o">}</span>
</span><span class="line">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">          <span class="n">cache</span><span class="o">.</span><span class="na">getReadWriteLock</span><span class="o">().</span><span class="na">readLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">,</span> <span class="n">resultHandler</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">CacheKey</span> <span class="nf">createCacheKey</span><span class="o">(</span><span class="n">MappedStatement</span> <span class="n">ms</span><span class="o">,</span> <span class="n">Object</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">createCacheKey</span><span class="o">(</span><span class="n">ms</span><span class="o">,</span> <span class="n">parameterObject</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>与iBatis最大的不同是，在从缓存中读取数据之前，要先获取读锁。读锁可以由多个读线程同时持有，而写线程同时只能有一个线程持有。但是读写锁会有一个饥渴写的问题，具体可以参考<a href="http://en.wikipedia.org/wiki/Readers-writers_problem" title="Readers-writers_problem">读写锁的问题</a>。</p>

<p>Executor类也是采用了装饰模式来实现，查询对象委托给持有的Executor类的实例来执行。如果缓存中没有，就交TransactionalCacheManager类来把对象存放到缓存中去。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>TransactionalCacheManager.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionalCacheManager</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">cache</span> <span class="o">,</span> <span class="n">TransactionalCache</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">transactionalCaches</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">cache</span> <span class="o">,</span> <span class="n">TransactionalCache</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;();</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">(</span><span class="n">Cache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">getTransactionalCache</span><span class="o">(</span><span class="n">cache</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">Cache</span> <span class="n">cache</span><span class="o">,</span> <span class="n">CacheKey</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">getTransactionalCache</span><span class="o">(</span><span class="n">cache</span><span class="o">).</span><span class="na">putObject</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="n">TransactionalCache</span> <span class="n">txCache</span> <span class="o">:</span> <span class="n">transactionalCaches</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">      <span class="n">txCache</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="n">TransactionalCache</span> <span class="n">txCache</span> <span class="o">:</span> <span class="n">transactionalCaches</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">      <span class="n">txCache</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">TransactionalCache</span> <span class="nf">getTransactionalCache</span><span class="o">(</span><span class="n">Cache</span> <span class="n">cache</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">TransactionalCache</span> <span class="n">txCache</span> <span class="o">=</span> <span class="n">transactionalCaches</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cache</span><span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">txCache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">txCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionalCache</span><span class="o">(</span><span class="n">cache</span><span class="o">);</span>
</span><span class="line">      <span class="n">transactionalCaches</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">txCache</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">txCache</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>第一次看到这个类的名字感觉有点奇怪，缓存相关的类怎么取了个事务的名字，后来读到TransactionalCache类后才明白原因。继续往下看，在TransactionalCacheManager中，最终还是用TransactionalCache类的put方法。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>TransactionalCache.java  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionalCache</span> <span class="kd">implements</span> <span class="n">Cache</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">Cache</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">clearOnCommit</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">object</span> <span class="o">,</span> <span class="n">AddEntry</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">entriesToAddOnCommit</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Map</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">object</span> <span class="o">,</span> <span class="n">RemoveEntry</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">entriesToRemoveOnCommit</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">entriesToRemoveOnCommit</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="n">entriesToAddOnCommit</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="n">AddEntry</span><span class="o">(</span><span class="n">delegate</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">object</span><span class="o">));</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">removeObject</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">entriesToAddOnCommit</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">    <span class="n">entriesToRemoveOnCommit</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="n">RemoveEntry</span><span class="o">(</span><span class="n">delegate</span><span class="o">,</span> <span class="n">key</span><span class="o">));</span>
</span><span class="line">    <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">delegate</span><span class="o">.</span><span class="na">getReadWriteLock</span><span class="o">().</span><span class="na">writeLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">clearOnCommit</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">delegate</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span><span class="n">RemoveEntry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entriesToRemoveOnCommit</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">          <span class="n">entry</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="k">for</span> <span class="o">(</span><span class="n">AddEntry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entriesToAddOnCommit</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">        <span class="n">entry</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">reset</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">      <span class="n">delegate</span><span class="o">.</span><span class="na">getReadWriteLock</span><span class="o">().</span><span class="na">writeLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们可以看到在TransactionalCache类里也维护着两个HashMap：entriesToAddOnCommit和entriesToRemoveOnCommit。当在TransactionalCacheManager中调用putObject和removeObject方法的时候并不是马上就把对象存放到缓存或者从缓存中删除，而是先把这个对象放到这两个HashMap之中的一个里，然后当执行commit方法时再真正地把对象存放到缓存或者从缓存中删除。现在我们应该可以明白为TransactionalCacheManager和TransactionalCache这两个类要加上事务的前缀了，因为commit方法是一个原子操作，一次会操作多个对象，要么一起成功，要么就一起失败。</p>

<p><strong>三.总结</strong></p>

<p>通过这次对iBatis以及myBatis的源码进行分析，发现他们的缓存在设计和实现上都存在一些问题。比如iBatis有两个集合不同步的问题，myBatis的读写锁有写饥渴问题等。这些问题都会给性能造成影响，所以还是不建议在生产环境中使用iBatis或者myBatis自带的二级缓存，只使用他们的ORM功能，而二级缓存还是交给Memcached来实现吧。</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Foredoomed</span></span>

      








  


<time datetime="2011-09-16T18:41:00+08:00" pubdate data-updated="true">Sep 16<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/opensource/'>opensource</a>
  
</span>


    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>Twitter</h1>
<ul>
<li>
<a href="http://twitter.com/comomt">Follow me on twitter</a>
</li>
</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/08/26/skip-list-in-a-netshell/">Skip List原理简述</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/18/head-first-coroutine/">深入浅出Coroutine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/17/install-munin-on-vps/">用Munin监控VPS的运行情况</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/16/linux-frequently-used-commands/">Linux常用命令</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/14/setup-octopress-on-vps/">快速搭建Octopress博客环境</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/algorithm/'>algorithm (1)</a></li>
<li class='category'><a href='/blog/categories/algorithms/'>algorithms (1)</a></li>
<li class='category'><a href='/blog/categories/architecture/'>architecture (4)</a></li>
<li class='category'><a href='/blog/categories/browsers/'>browsers (10)</a></li>
<li class='category'><a href='/blog/categories/java/'>java (10)</a></li>
<li class='category'><a href='/blog/categories/life/'>life (8)</a></li>
<li class='category'><a href='/blog/categories/linux/'>linux (1)</a></li>
<li class='category'><a href='/blog/categories/nosql/'>nosql (1)</a></li>
<li class='category'><a href='/blog/categories/notes/'>notes (4)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (2)</a></li>
<li class='category'><a href='/blog/categories/opensource/'>opensource (7)</a></li>
<li class='category'><a href='/blog/categories/programming/'>programming (6)</a></li>
<li class='category'><a href='/blog/categories/vim/'>vim (1)</a></li>
<li class='category'><a href='/blog/categories/vps/'>vps (4)</a></li>

  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
<img alt="Creative Commons License" style="border-width:0;" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br/>
Blog content is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.<br/>
  Copyright &copy; 2012 - Foredoomed -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zhixingheyi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://liuxuan.info/blog/2011/09/16/ibatis-and-mybatis-source-code-analysis-cache/';
        var disqus_url = 'http://liuxuan.info/blog/2011/09/16/ibatis-and-mybatis-source-code-analysis-cache/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







</body>
</html>
