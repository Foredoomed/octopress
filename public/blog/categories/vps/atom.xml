<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: vps | Zhixingheyi]]></title>
  <link href="http://liuxuan.info/blog/categories/vps/atom.xml" rel="self"/>
  <link href="http://liuxuan.info/"/>
  <updated>2012-11-28T21:10:24+08:00</updated>
  <id>http://liuxuan.info/</id>
  <author>
    <name><![CDATA[Foredoomed]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[用Munin监控VPS的运行情况]]></title>
    <link href="http://liuxuan.info/blog/2012/06/17/install-munin-on-vps/"/>
    <updated>2012-06-17T13:42:00+08:00</updated>
    <id>http://liuxuan.info/blog/2012/06/17/install-munin-on-vps</id>
    <content type="html"><![CDATA[<p>因为换了vps，所以还要重新安装监控软件。而Linux平台上的系统监控软件还是很多的，比如大名顶顶的<a href="http://www.nagios.org/">Nagios</a>，<a href="http://www.cacti.net/">Cacti</a>和<a href="http://www.zabbix.com/">Zabbix</a>,还有<a href="http://oss.oetiker.ch/mrtg/">MRTG</a>。Nagios是一个比较重量级的软件，而且还必须搭配许多插件才能满足需求，所以在小内存vps上不适用；Cacti是通过<a href="http://en.wikipedia.org/wiki/Simple_Network_Management_Protocol">SNMP</a>协议来监控系统，这意味着还要为它在后台开启SNMP进程，这对于小内存vps也不可取，还有cacti需要数据库的支持，web前端还需要php，所以综上也放弃；Zabbix虽然不错，但它也需要有数据库的支持，所以也放弃；而MRTG只能够监控网络使用情况，不能够监控CPU，磁盘等设备，所以还是放弃。最后我选择的是<a href="http://munin-monitoring.org/">Munin</a>,它的有点是不仅轻量，不需要数据库，可以直接生成静态页面，应该说Munin是小内存vps上的理想选择。</p>

<!-- more -->

<p>如果想要安装Munin的最新版本就需要自己编译安装，软件库里的版本还是有点旧。但是自己编译安装会比较麻烦，因为要安装编译所需要的很多依赖库，所以我还是选择从软件库里直接安装。好了，下面就开始安装Munin，操作系统是CentOS 6 32位。</p>

<p>首先安装EPEL软件库，如果已经装过就跳过此步</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-7.noarch.rpm
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后安装munin</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install munin munin-node
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>设置开机启动和目录权限</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chkconfig munin-node on&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;chown -R munin:munin /var/www/html/munin/
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>接下来就是配置munin</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /etc/munin&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;vim munin.conf&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 打开下面几行的注释
</span><span class='line'>dbdir   /var/lib/munin
</span><span class='line'>htmldir /var/www/html/munin
</span><span class='line'>logdir  /var/log/munin
</span><span class='line'>rundir  /var/run/munin&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tmpldir /etc/munin/templates&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 修改munin页面上显示的munin
</span><span class='line'><span class="o">[</span>liuxuan.info<span class="o">]</span>
</span><span class='line'>    address 127.0.0.1
</span><span class='line'>    use_node_name yes
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置munin-node</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>// 修改hostname
</span><span class='line'>host_name   liuxuan.info&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 如果有多台机器需要监控的话还需要加上他们的IP地址
</span><span class='line'>allow ^xxx.xxx.xxx.xxx<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置对nginx的监控</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /etc/munin/plugins/
</span><span class='line'>ln -s /usr/share/munin/plugins/nginx_request nginx_request
</span><span class='line'>ln -s /usr/share/munin/plugins/nginx_status nginx_status&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 修改nginx_request里的hostname，搜索<span class="nv">$URL</span>,把其中的<span class="nv">$fqdn</span>改为localhost
</span><span class='line'>// 然后输入下面的命令，如果输出yes则说明配置成功
</span><span class='line'>perl nginx_request autoconf&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 配置nginx
</span><span class='line'><span class="nb">cd</span> /etc/nginx/conf.d
</span><span class='line'>vim munin.conf
</span><span class='line'>// 然后加入下面的配置
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>        listen 127.0.0.1;
</span><span class='line'>        server_name localhost;
</span><span class='line'>        location /nginx_status <span class="o">{</span>
</span><span class='line'>                stub_status on;
</span><span class='line'>                access_log   off;
</span><span class='line'>                allow 127.0.0.1;
</span><span class='line'>                deny all;
</span><span class='line'>        <span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;    location /munin <span class="o">{</span>
</span><span class='line'>    	root /var/www/html/munin;
</span><span class='line'>  			expires off;
</span><span class='line'>  			access_log   off;
</span><span class='line'>  			auth_basic <span class="s2">&quot;Munin&quot;</span>;
</span><span class='line'>  			auth_basic_user_file /etc/nginx/.htpasswd;
</span><span class='line'>	 <span class="o">}</span> <span class="o">}</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 重启nginx使配置生效
</span><span class='line'>nginx -s reload&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;// 设置访问munin的用户名和秘密
</span><span class='line'>htpasswd -c /etc/nginx/.htpasswd username
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>// 最后设置计划任务每5分钟获取数据
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo -u munin crontab -e
</span><span class='line'>*/5 * * * *  /usr/bin/munin-cron
</span><span class='line'>// 一定要先执行下面这行命令，否则不会生成index.html，访问会报403错误
</span><span class='line'>sudo -u munin munin-cron
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>到现在为止配置基本完成了，启动munin试下吧</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/munin-node restart
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后打开浏览器访问<code>http://your.domain/munin/</code>，输入用户名和密码后就应可以看到munin的首页了，一开始是没有数据的，耐心等待几分钟后数据就会更新了。</p>

<p>参考文章</p>

<ol>
  <li><a href="http://www.darkcoding.net/software/setting-up-munin-on-ubuntu/">Setting up Munin on Ubuntu</a></li>
  <li><a href="http://munin-monitoring.org/wiki/Documentation">Munin Documentation</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在VPS上安装网络流量监控工具vnStat]]></title>
    <link href="http://liuxuan.info/blog/2011/08/22/install-vnstat-on-vps/"/>
    <updated>2011-08-22T18:04:00+08:00</updated>
    <id>http://liuxuan.info/blog/2011/08/22/install-vnstat-on-vps</id>
    <content type="html"><![CDATA[<p>用上VPS以后博客的访问速度是比以前快了很多，但是也有烦心的事，就是担心每个月的流量有没有超标。你可以通过VPS提供给你的Control Panel的地址登录，然后查看流量数据。但是这种方法始终有点复杂，最好有种直接输入一个URL就能查看流量数据的方法。在Google上搜索了一会儿之后，终于找到了一个好工具：<a href="http://humdi.net/vnstat/" title="vnStat">vnStat</a>。 </p>

<!--more-->

<p>vnStat是Linux和BSD平台上基于控制台的网络流量监控工具。它使用的是Linux内核提供的网络接口统计作为信息源。vnStat不会嗅探网络并且保证占系统资源少，需要注意的是内核版本要在2.2之上。</p>

<p>vnStat只是一个基于控制台的工具，我们还需要安装一个它的PHP扩展<a href="href=&quot;http://www.sqweek.com/sqweek/index.php?p=1" title="vnStat PHP frontend">vnStat PHP frontend</a>，那么我们就能直接通过流量器来查看流量数据了。</p>

<p>速度安装起来：</p>

<p>1.安装vnStat:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://humdi.net/vnstat/vnstat-1.11.tar.gz
</span><span class='line'>tar zxvf vnstat-1.11.tar.gz
</span><span class='line'><span class="nb">cd </span>vnstat-1.11
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>2.安装vnStat PHP frontend：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://www.sqweek.com/sqweek/files/vnstat_php_frontend-1.5.1.tar.gz
</span><span class='line'>cp -r vnstat_php_frontend-1.5.1 /你的Nginx的根目录/vnstat
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后就可以通过访问<code>http://www.yourdomain.com/vnstat</code>，应该就可以看到流量数据页面了，但是现在还没有数据，接下来我们来给系统生成数据。</p>

<p>3.建立流量数据库:</p>

<p>首先查看你是哪种外网网卡：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ifconfig    //Xen一般是eth0；OpenVZ一般是venet0
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后生成数据库：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/bin/vnstat -u -i venet0  //因为我的VPS是基于OpenVZ的，所以就是venet0
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置通过cron的方式定时更新数据库,编辑<code>/etc/cron.d/vnstat</code>文件，加入下面的内容：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>0-55/5 * * * *   root   vnstat -u -i venet0
</span><span class='line'>0-55/5 * * * *   root   vnstat –dumpdb -i venet0 &amp;gt;/var/lib/vnstat/vnstat_dump_venet0
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>注意：第二行是为了更新venet0的数据后，dump出来一个文件提供给PHP访问.这里dump出来的vnstat_dump_venet0文件名是有规定的。</p>

<p>4.修改配置文件,编辑<code>/你的Nginx的根目录/vnstat/config.php</code>：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$language</span> <span class="o">=</span> ‘en’;
</span><span class='line'><span class="nv">$iface_list</span> <span class="o">=</span> array<span class="o">(</span>‘venet0’<span class="o">)</span>;
</span><span class='line'><span class="nv">$iface_title</span><span class="o">[</span>‘venet0’<span class="o">]</span> <span class="o">=</span> ‘VPS’;
</span><span class='line'><span class="nv">$data_dir</span> <span class="o">=</span> ‘/var/lib/vnstat/’;
</span><span class='line'><span class="nv">$graph_format</span><span class="o">=</span>’png’;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>到这里安装就都完成了，就这么简单。现在访问www.yourdomain.com/vnstat就会发现有流量统计了,统计数据更新是５分钟刷新一次。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在VPS上安装dropbear,vsftp和pptpd]]></title>
    <link href="http://liuxuan.info/blog/2011/08/21/install-dropbear-vsftp-pptpd-on-vps/"/>
    <updated>2011-08-21T17:31:00+08:00</updated>
    <id>http://liuxuan.info/blog/2011/08/21/install-dropbear-vsftp-pptpd-on-vps</id>
    <content type="html"><![CDATA[<p><strong>编译安装Dropbear</strong></p>

<p>首先修改OpenSSH的端口,编辑<code>/etc/ssh/sshd_config</code>文件，找到<code>Port 22</code>这一行，并修改为<code>Port 2222</code>。</p>

<p>然后重启OpenSSH：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service sshd restart
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>编译安装Dropbear:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /data/software
</span><span class='line'>wget http://matt.ucc.asn.au/dropbear/dropbear-0.53.1.tar.gz
</span><span class='line'>tar -zxvf dropbear-0.53.1.tar.gz
</span><span class='line'><span class="nb">cd </span>dropbear-0.53.1
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>生成公钥：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir /etc/dropbear
</span><span class='line'>/usr/local/bin/dropbearkey -t dss -f /etc/dropbear/dropbear_dss_host_key
</span><span class='line'>/usr/local/bin/dropbearkey -t rsa -s 4096 -f /etc/dropbear/dropbear_rsa_host_key
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>启动Dropbear：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/sbin/dropbear start
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置开机自动启动：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chkconfig –add dropbear
</span><span class='line'>chkconfig dropbear on
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Dropbear正确安装完成后，如果能够用ssh登录，那么就可以删除OpenSSH了:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum remove openssh
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<!--more-->

<p><strong>编译安装vsftp</strong></p>

<p>如果编译安装的话会报错，要自己手动复制文件，所以我就从软件库自动安装了：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install vsftpd
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>创建FTP用户：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/sbin/groupadd ftp
</span><span class='line'>/usr/sbin/useradd -g ftp ftp
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>建立FTP默认目录:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir /var/ftp
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>设定FTP的home目录为/var/ftp：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>useradd -d /var/ftp -s /sbin/nologin ftp
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>设定home目录所有者和权限:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chown ftp:ftp /var/ftp
</span><span class='line'>chmod 755 /var/ftp
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>编辑vsftp配置文件<code>/etc/vsftpd/vsftpd.conf</code>,修改为：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">anonymous_enable</span><span class="o">=</span>no
</span><span class='line'><span class="nv">listen</span><span class="o">=</span>yes&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;//并在文件末尾添加：
</span><span class='line'><span class="nv">local_root</span><span class="o">=</span>/var/ftp/pub
</span><span class='line'><span class="nv">use_localtime</span><span class="o">=</span>yes
</span><span class='line'><span class="nv">connect_timeout</span><span class="o">=</span>60
</span><span class='line'><span class="nv">accept_timeout</span><span class="o">=</span>60
</span><span class='line'><span class="nv">max_clients</span><span class="o">=</span>10
</span><span class='line'><span class="nv">max_per_ip</span><span class="o">=</span>10
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置开机自动启动
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chkconfig –add vsftpd
</span><span class='line'>chkconfig vsftpd on
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>安装pptpd</strong></p>

<p>1.首先用ssh登录VPS，检查VPS是否有必要的支持，否则将导致无法安装(如果是buyvm的VPS可以跳过这步)</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>modprobe ppp-compress-18 &amp;amp;&amp;amp; <span class="nb">echo </span>ok
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>用模块方式支持MPPE加密模式浏览，如果内核支持则检测不到。如果显示“ok”表明通过，不过还需要做另一个检查：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat /dev/net/tun
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>如果显示结果为下面的文本就表明通过：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat: /dev/net/tun: File descriptor in bad state
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>上述两条检测只需一条通过，即可安装pptpd。如果还有其他问题，就提Ticket给服务商替你解决。</p>

<p>2.安装ppp：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -ivh http://poptop.sourceforge.net/yum/stable/rhel6/i386/ppp-2.4.5-17.0.rhel6.i686.rpm
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>3.安装pptpd:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rpm -ivh http://poptop.sourceforge.net/yum/stable/rhel6/i386/pptpd-1.3.4-2.el6.i686.rpm
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>4.配置pptpd:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/pptpd.conf
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>把下面字段前面的#去掉即可：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>localip 192.168.0.1
</span><span class='line'>remoteip 192.168.0.234-238,192.168.0.245
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>接下来再编辑<code>/etc/ppp/options.pptpd</code>文件：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/ppp/options.pptpd
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>去掉<code>ms-dns</code>前面的#，并修改成如下字段：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ms-dns 8.8.8.8
</span><span class='line'>ms-dns 8.8.4.4
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>5.设置pptpd账号和密码：</p>

<p>编辑<code>/etc/ppp/chap-secrets</code>文件：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/ppp/chap-secrets
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>直接输入如下字段,username和password就是你要登录VPN的用户名和密码：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>username pptpd password *
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>6.修改内核设置，使其支持转发:</p>

<p>编辑<code>/etc/sysctl.conf</code>文件：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/sysctl.conf
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>做下面的修改：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>net.ipv4.ip_forward<span class="o">=</span>1
</span><span class='line'><span class="c"># net.ipv4.tcp_syncookies = 1  //注释这行</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>保存退出，并执行下面的命令来使它生效：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sysctl -p
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>7.添加iptables转发规则：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT –to-source xxx.xxx.xxx.xxx  //xxx.xxx.xxx.xxx为你的VPS的公网IP地址
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>保存iptables转发规则：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/iptables save
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>重启iptables：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/iptables restart
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>8.重启pptpd服务：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/etc/init.d/pptpd restart
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>9.设置开机自动启动</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chkconfig –add pptpd
</span><span class='line'>chkconfig pptpd on
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在VPS上搭建LNMP(Linux/Nginx/MySQL/PHP)]]></title>
    <link href="http://liuxuan.info/blog/2011/08/20/setup-lnmp-on-vps/"/>
    <updated>2011-08-20T17:12:00+08:00</updated>
    <id>http://liuxuan.info/blog/2011/08/20/setup-lnmp-on-vps</id>
    <content type="html"><![CDATA[<p><strong>一.写在最前</strong></p>

<p>从我开博到现在也有半年有余了，之前一直是放在一个共享空间里。当初选择共享空间主要是因为价格便宜，而且我只在空间里放一个WordPress，不需要很大的空间和流量。但是在这半年多时间里，这个空间经常出现响应速度变得很慢，FTP和CPANEL无法登录等问题，真让我的忍耐到达了极点；再加上我们不知道什么原因访问一些网站经常返回错误页面，所以我决定抛弃这个空间(一年的时间还没到，浪费劳资的钱啊。。。)，转投VPS的怀抱。 <!--more--></p>

<p>其实在几年之前就知道VPS这样东西了，但是真正当我要去搞一个的时候，却发现有太多的选择。经过一番思想斗争，我最终选择了<a href="http://buyvm.net/" title="buyvm">buyvm</a>这个VPS。如果你要问我为什么选择这个VPS，我想有三个原因：1.便宜 2.便宜 3.还是便宜。谁不想要被称为最好的VPS之称的<a href="http://www.linode.com/" title="Linode">Linode</a>啊，但是穷逼只能捡便宜的用。当然，并不是便宜的就不好，buyvm的VPS虽然便宜，质量和服务也是非常好的，并且它还在<a href="http://www.lowendbox.com" title="lowendbox">lowendbox</a>的评选中获得过第三名的好成绩。</p>

<p>重要的来了，你需要搞清楚在VPS上放些什么东西，因为这关系着你选OpenVZ还是Xen。提前告知一下：<strong>如果你想在VPS上装L2TP/IPSec VPN的话，就不要选OpenVZ</strong>。以我的经验来看，OpenVZ还是有很多限制的，如果手头宽裕的话还是首选Xen吧。好了，扯蛋完毕，开工搭建。</p>

<p><strong>二.安装LNMP+Dropbear+vsFTP</strong></p>

<p>本次搭建必要的是：</p>
<ul>
<li>1台VPS</li>
<li>CentOS操作系统(我的是CentOS 5.6，其他Linux发行版应该差不多)</li>
<li>能够以root权限从SSH登录</li>
<li>有足够的耐心和时间，因为接下来的工作还是蛮多的</li>
</ul>

<p><strong>1.安装必要的软件包</strong></p>

<p>首先以root权限从SSH登录，然后运行下面的命令：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum -y install gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel libidn libidn-devel openssl openssl-devel openldap openldap-devel nss_ldap openldap-clients openldap-servers
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>2.在home目录新建一个software目录用来存放这次搭建所需的软件：</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~
</span><span class='line'>mkdir software
</span><span class='line'><span class="nb">cd </span>software
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后下载我们需要的软件：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://nginx.org/download/nginx-1.0.5.tar.gz
</span><span class='line'>wget http://www.php.net/get/php-5.3.7.tar.gz/from/a/mirror
</span><span class='line'>wget http://dev.mysql.com/downloads/mirror.php?id<span class="o">=</span>403104#mirrors
</span><span class='line'>wget http://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.14.tar.gz
</span><span class='line'>wget http://sourceforge.net/projects/mcrypt/files/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.bz2/download
</span><span class='line'>wget http://sourceforge.net/projects/mcrypt/files/MCrypt/2.6.8/mcrypt-2.6.8.tar.gz/download
</span><span class='line'>wget http://pecl.php.net/get/memcache-3.0.6.tgz
</span><span class='line'>wget http://sourceforge.net/projects/mhash/files/mhash/0.9.9.9/mhash-0.9.9.9.tar.gz/download
</span><span class='line'>wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/
</span><span class='line'>wget http://pecl.php.net/get/APC-3.1.9.tgz
</span><span class='line'>wget http://pecl.php.net/get/PDO_MYSQL-1.0.2.tgz
</span><span class='line'>wget ftp://ftp.imagemagick.org/pub/ImageMagick/ImageMagick.tar.gz
</span><span class='line'>wget http://pecl.php.net/get/imagick-3.0.1.tgz
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>3.编译安装MySQL</strong></p>

<p>首先添加mysql用户组和用户：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/sbin/groupadd mysql
</span><span class='line'>/usr/sbin/useradd -g mysql mysql
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>编译安装mysql：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf mysql-5.1.58.tar.gz
</span><span class='line'><span class="nb">cd </span>mysql-5.1.58
</span><span class='line'>./configure –prefix<span class="o">=</span>/usr/local/webserver/mysql/ –localstatedir<span class="o">=</span>/usr/webserver/local/mysql/data –with-unix-socket-path<span class="o">=</span>/tmp/mysql.sock –with-charset<span class="o">=</span>utf8 –with-collation<span class="o">=</span>utf8_general_ci –enable-assembler –with-extra-charsets<span class="o">=</span>complex –enable-thread-safe-client –with-big-tables –with-readline –with-ssl –with-embedded-server –enable-local-infile –with-client-ldflags<span class="o">=</span>-all-static –with-mysqld-ldflags<span class="o">=</span>-all-static –with-plugins<span class="o">=</span>partition,innobase,myisammrg
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span><span class='line'>cp support-files/my-medium.cnf /usr/local/webserver/mysql/my.cnf
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>赋予mysql权限：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod +w /usr/local/webserver/mysql
</span><span class='line'>chown -R mysql:mysql /usr/local/webserver/mysql
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>以mysql用户建立数据库表：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/webserver/mysql/bin/mysql_install_db –basedir<span class="o">=</span>/usr/local/webserver/mysql –datadir<span class="o">=</span>/usr/local/webserver/mysql/data –user<span class="o">=</span>mysql
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>修改mysql的配置文件为：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>client<span class="o">]</span>
</span><span class='line'>character-set-server <span class="o">=</span> utf8
</span><span class='line'><span class="nv">port</span>		<span class="o">=</span> 3306
</span><span class='line'><span class="nv">socket</span>		<span class="o">=</span> /tmp/mysql.sock&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>mysqld<span class="o">]</span>
</span><span class='line'>character-set-server <span class="o">=</span> utf8
</span><span class='line'><span class="nv">port</span>		<span class="o">=</span> 3306
</span><span class='line'><span class="nv">socket</span>		<span class="o">=</span> /tmp/mysql.sock
</span><span class='line'>skip-locking
</span><span class='line'><span class="nv">key_buffer_size</span> <span class="o">=</span> 16M
</span><span class='line'><span class="nv">max_allowed_packet</span> <span class="o">=</span> 16M
</span><span class='line'><span class="nv">table_open_cache</span> <span class="o">=</span> 64
</span><span class='line'><span class="nv">sort_buffer_size</span> <span class="o">=</span> 128K
</span><span class='line'><span class="nv">net_buffer_length</span> <span class="o">=</span> 8K
</span><span class='line'><span class="nv">read_buffer_size</span> <span class="o">=</span> 256K
</span><span class='line'><span class="nv">read_rnd_buffer_size</span> <span class="o">=</span> 512K
</span><span class='line'><span class="nv">myisam_sort_buffer_size</span> <span class="o">=</span> 8M&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;basedir <span class="o">=</span> /usr/local/webserver/mysql
</span><span class='line'><span class="nv">datadir</span> <span class="o">=</span> /usr/local/webserver/mysql/data
</span><span class='line'><span class="nv">open_files_limit</span> <span class="o">=</span> 600
</span><span class='line'><span class="nv">back_log</span> <span class="o">=</span> 20
</span><span class='line'><span class="nv">max_connections</span> <span class="o">=</span> 100
</span><span class='line'><span class="nv">max_connect_errors</span> <span class="o">=</span> 200
</span><span class='line'><span class="nv">table_cache</span> <span class="o">=</span> 60
</span><span class='line'>external-locking <span class="o">=</span> FALSE
</span><span class='line'><span class="nv">join_buffer_size</span> <span class="o">=</span> 128K
</span><span class='line'><span class="nv">thread_cache_size</span> <span class="o">=</span> 10
</span><span class='line'><span class="nv">thread_concurrency</span> <span class="o">=</span> 8
</span><span class='line'><span class="nv">query_cache_size</span> <span class="o">=</span> 0M
</span><span class='line'><span class="nv">query_cache_limit</span> <span class="o">=</span> 2M
</span><span class='line'><span class="nv">query_cache_min_res_unit</span> <span class="o">=</span> 2k
</span><span class='line'><span class="nv">default_table_type</span> <span class="o">=</span> MyISAM
</span><span class='line'><span class="nv">thread_stack</span> <span class="o">=</span> 192K
</span><span class='line'><span class="nv">tmp_table_size</span> <span class="o">=</span> 512K
</span><span class='line'><span class="nv">max_heap_table_size</span> <span class="o">=</span> 32M
</span><span class='line'><span class="nv">long_query_time</span> <span class="o">=</span> 1
</span><span class='line'>log_long_format
</span><span class='line'><span class="nv">binlog_cache_size</span> <span class="o">=</span> 2M
</span><span class='line'><span class="nv">max_binlog_cache_size</span> <span class="o">=</span> 4M
</span><span class='line'><span class="nv">max_binlog_size</span> <span class="o">=</span> 512M
</span><span class='line'><span class="nv">expire_logs_days</span> <span class="o">=</span> 7&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>myisamchk<span class="o">]</span>
</span><span class='line'><span class="nv">key_buffer_size</span> <span class="o">=</span> 4M
</span><span class='line'><span class="nv">sort_buffer_size</span> <span class="o">=</span> 1M
</span><span class='line'><span class="nv">read_buffer</span> <span class="o">=</span> 2M
</span><span class='line'><span class="nv">write_buffer</span> <span class="o">=</span> 2M&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;read_rnd_buffer_size <span class="o">=</span> 2M
</span><span class='line'><span class="nv">bulk_insert_buffer_size</span> <span class="o">=</span> 2M
</span><span class='line'><span class="nv">myisam_sort_buffer_size</span> <span class="o">=</span> 4M
</span><span class='line'><span class="nv">myisam_max_sort_file_size</span> <span class="o">=</span> 10G
</span><span class='line'><span class="nv">myisam_max_extra_sort_file_size</span> <span class="o">=</span> 10G
</span><span class='line'><span class="nv">myisam_repair_threads</span> <span class="o">=</span> 1
</span><span class='line'>myisam_recover
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>创建一个脚本，方便管理mysql：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /usr/local/webserver/mysql/mysql
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在其中添加下面的脚本命令：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function_start_mysql<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="nb">printf</span> “Starting MySQL…<span class="se">\n</span>”
</span><span class='line'>   /bin/sh /usr/local/webserver/mysql/bin/mysqld_safe –defaults-file<span class="o">=</span>/usr/local/webserver/mysql/my.cnf &amp;amp;
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function_stop_mysql<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="nb">printf</span> “Stopping MySQL…<span class="se">\n</span>”
</span><span class='line'>   /usr/local/webserver/mysql/bin/mysqladmin -u mysql -pmysql shutdown
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function_restart_mysql<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="nb">printf</span> “Restarting MySQL…<span class="se">\n</span>”
</span><span class='line'>   function_stop_mysql
</span><span class='line'>   sleep 5
</span><span class='line'>   function_start_mysql
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;function_kill_mysql<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="nb">kill</span> -9 <span class="k">$(</span>ps -ef | grep ‘bin/mysqld_safe’ | grep 3306 | awk ‘<span class="o">{</span><span class="nb">printf</span> <span class="nv">$2</span><span class="o">}</span>’<span class="k">)</span>
</span><span class='line'>   <span class="nb">kill</span> -9 <span class="k">$(</span>ps -ef | grep ‘libexec/mysqld’ | grep 3306 | awk ‘<span class="o">{</span><span class="nb">printf</span> <span class="nv">$2</span><span class="o">}</span>’<span class="k">)</span>
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">[</span> “<span class="nv">$1</span>” <span class="o">=</span> “start” <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>function_start_mysql
</span><span class='line'><span class="k">elif</span> <span class="o">[</span> “<span class="nv">$1</span>” <span class="o">=</span> “stop” <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>function_stop_mysql
</span><span class='line'><span class="k">elif</span> <span class="o">[</span> “<span class="nv">$1</span>” <span class="o">=</span> “restart” <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>function_restart_mysql
</span><span class='line'><span class="k">elif</span> <span class="o">[</span> “<span class="nv">$1</span>” <span class="o">=</span> “kill” <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>function_kill_mysql
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="nb">printf</span> “Usage: /usr/local/webserver/mysql <span class="o">{</span>start|stop|restart|kill<span class="o">}</span><span class="se">\n</span>”
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后赋予脚本执行权限：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod +x /usr/local/webserver/mysql/mysql
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>启动mysql：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/webserver/mysql/mysql start
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>给mysql用户赋予数据库的所有权限：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>GRANT ALL PRIVILEGES ON &lt;em&gt;.&lt;/em&gt; TO ‘mysql’@’localhost’ IDENTIFIED BY ‘mysql’;
</span><span class='line'>GRANT ALL PRIVILEGES ON &lt;em&gt;.&lt;/em&gt; TO ‘mysql’@’127.0.0.1’ IDENTIFIED BY ‘mysql’;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置开机自启动mysql</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/rc.local
</span><span class='line'>/usr/local/webserver/mysql/bin/mysqld_safe –defaults-file<span class="o">=</span>/usr/local/webserver/mysql/my.cnf &amp;amp;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>4.编译安装PHP</strong></p>

<p>首先创建一个用户和组(用来管理PHP/Nginx/Wordpress)
创建用户和组</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>groupadd www
</span><span class='line'>useradd -g www www
</span><span class='line'>mkdir -p /data/htdocs/blog  //blog目录是Wordpress的根目录
</span><span class='line'>chmod +w /data/htdocs/blog
</span><span class='line'>chown -R www:www /data/htdocs/blog
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>编译安装PHP所需的支持库：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf libiconv-1.14.tar.gz
</span><span class='line'><span class="nb">cd </span>libiconv-1.13.1/
</span><span class='line'>./configure –prefix<span class="o">=</span>/usr/local
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf libmcrypt-2.5.8.tar.gz
</span><span class='line'><span class="nb">cd </span>libmcrypt-2.5.8/
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span><span class='line'>/sbin/ldconfig
</span><span class='line'><span class="nb">cd </span>libltdl
</span><span class='line'>./configure –enable-ltdl-install
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf mhash-0.9.9.9.tar.gz
</span><span class='line'><span class="nb">cd </span>mhash-0.9.9.9/
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf mcrypt-2.6.8.tar.gz
</span><span class='line'><span class="nb">cd </span>mcrypt-2.6.8/
</span><span class='line'>/sbin/ldconfig
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;ln -s /usr/local/lib/libmcrypt.la /usr/lib/libmcrypt.la
</span><span class='line'>ln -s /usr/local/lib/libmcrypt.so /usr/lib/libmcrypt.so
</span><span class='line'>ln -s /usr/local/lib/libmcrypt.so.4 /usr/lib/libmcrypt.so.4
</span><span class='line'>ln -s /usr/local/lib/libmcrypt.so.4.4.8 /usr/lib/libmcrypt.so.4.4.8
</span><span class='line'>ln -s /usr/local/lib/libmhash.a /usr/lib/libmhash.a
</span><span class='line'>ln -s /usr/local/lib/libmhash.la /usr/lib/libmhash.la
</span><span class='line'>ln -s /usr/local/lib/libmhash.so /usr/lib/libmhash.so
</span><span class='line'>ln -s /usr/local/lib/libmhash.so.2 /usr/lib/libmhash.so.2
</span><span class='line'>ln -s /usr/local/lib/libmhash.so.2.0.1 /usr/lib/libmhash.so.2.0.1
</span><span class='line'>ln -s /usr/local/bin/libmcrypt-config /usr/bin/libmcrypt-config
</span></code></pre></td></tr></table></div></figure></notextile></div>
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf php-5.3.7.tar.gz
</span><span class='line'><span class="nb">cd </span>php-5.3.7
</span><span class='line'>./configure –prefix<span class="o">=</span>/usr/local/webserver/php –with-config-file-path<span class="o">=</span>/usr/local/webserver/php/etc –with-mysql<span class="o">=</span>/usr/local/webserver/mysql –with-mysqli<span class="o">=</span>/usr/local/webserver/mysql/bin/mysql_config –with-iconv-dir<span class="o">=</span>/usr/local –with-freetype-dir –with-jpeg-dir –with-png-dir –with-zlib –with-libxml-dir<span class="o">=</span>/usr –enable-xml –disable-rpath  –enable-safe-mode –enable-bcmath –enable-shmop –enable-sysvsem –enable-inline-optimization –with-curl –with-curlwrappers –enable-mbregex  –enable-fpm  –enable-mbstring –with-mcrypt –with-gd –enable-gd-native-ttf –with-openssl –with-mhash –enable-pcntl –enable-sockets –with-ldap –with-ldap-sasl –with-xmlrpc –enable-ftp –enable-zip –enable-exif –enable-soap –without-pear –with-fpm-user<span class="o">=</span>www –with-fpm-group<span class="o">=</span>www
</span><span class='line'>make <span class="nv">ZEND_EXTRA_LIBS</span><span class="o">=</span>’-liconv’
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>如果遇到下面的问题：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/root/source/php-5.3.7/sapi/cli/php: error <span class="k">while </span>loading shared libraries: libmysqlclient.so.18: cannot open shared object file: No such file or directory
</span><span class='line'>make: *** <span class="o">[</span>ext/phar/phar.php<span class="o">]</span> Error 127
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>解决方法：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ln -s /usr/local/webserver/mysql/lib/libmysqlclient.so.18 /usr/lib/
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>然后再执行：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>make install
</span><span class='line'>cp php.ini-production /usr/local/webserver/php/etc/php.ini
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>安装PHP扩展包：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf memcache-3.0.6.tgz
</span><span class='line'><span class="nb">cd </span>memcache-3.0.6
</span><span class='line'>/usr/local/webserver/php/bin/phpize
</span><span class='line'>./configure –with-php-config<span class="o">=</span>/usr/local/webserver/php/bin/php-config
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar jxvf APC-3.1.9.tgz
</span><span class='line'><span class="nb">cd </span>APC-3.1.9
</span><span class='line'>/usr/local/webserver/php/bin/phpize
</span><span class='line'>./configure –with-php-config<span class="o">=</span>/usr/local/webserver/php/bin/php-config –prefix<span class="o">=</span>/usr/local/webserver/ –enable-apc –enable-apc-mmap –enable-apc-spinlocks
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf PDO_MYSQL-1.0.2.tgz
</span><span class='line'><span class="nb">cd </span>PDO_MYSQL-1.0.2
</span><span class='line'>/usr/local/webserver/php/bin/phpize
</span><span class='line'>./configure –with-php-config<span class="o">=</span>/usr/local/webserver/php/bin/php-config –with-pdo-mysql<span class="o">=</span>/usr/local/webserver/mysql
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf ImageMagick.tar.gz
</span><span class='line'><span class="nb">cd </span>ImageMagick-6.7.1-7
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;tar zxvf imagick-3.0.1.tgz
</span><span class='line'><span class="nb">cd </span>imagick-3.0.1
</span><span class='line'>/usr/local/webserver/php/bin/phpize
</span><span class='line'>./configure –with-php-config<span class="o">=</span>/usr/local/webserver/php/bin/php-config
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>修改php.ini文件:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">output_buffering</span> <span class="o">=</span> On
</span><span class='line'>cgi.fix_pathinfo <span class="o">=</span> 0&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;extension_dir <span class="o">=</span> “/usr/local/webserver/php/lib/php/extensions/no-debug-non-zts-20090626/”&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;//并在此行后增加以下几行
</span><span class='line'><span class="nv">extension</span> <span class="o">=</span> “memcache.so”
</span><span class='line'><span class="nv">extension</span> <span class="o">=</span> “pdo_mysql.so”
</span><span class='line'><span class="nv">extension</span> <span class="o">=</span> “imagick.so”&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>APC<span class="o">]</span>
</span><span class='line'>apc.enabled <span class="o">=</span> 1
</span><span class='line'>apc.shm_segments <span class="o">=</span> 1
</span><span class='line'>apc.shm_size <span class="o">=</span> 8M
</span><span class='line'>apc.ttl <span class="o">=</span> 7200
</span><span class='line'>apc.user_ttl <span class="o">=</span> 7200
</span><span class='line'>apc.optimization <span class="o">=</span> 1
</span><span class='line'>apc.num_files_hint <span class="o">=</span> 1024
</span><span class='line'>apc.mmap_file_mask <span class="o">=</span>/tmp/apc.XXXXXX
</span><span class='line'>apc.enable_cli <span class="o">=</span> 1
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>打开php-fpm.conf文件:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /usr/local/webserver/php/etc/php-fpm.conf
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>修改添加如下配置：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pm.max_children <span class="o">=</span> 1
</span><span class='line'><span class="nv">pid</span> <span class="o">=</span> run/php-fpm.pid
</span><span class='line'><span class="nv">error_log</span> <span class="o">=</span> log/php-fpm.log
</span><span class='line'><span class="nv">log_level</span> <span class="o">=</span> notice
</span><span class='line'>emergency_restart_threshold :10
</span><span class='line'>emergency_restart_interval:1m
</span><span class='line'>process_control_timeout:5s
</span><span class='line'>daemonize:yes&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;backlog:-1
</span><span class='line'>listen.owner <span class="o">=</span> www
</span><span class='line'>listen.group <span class="o">=</span> www
</span><span class='line'>listen.mode <span class="o">=</span> 0666
</span><span class='line'><span class="nv">user</span> <span class="o">=</span> www
</span><span class='line'><span class="nv">group</span> <span class="o">=</span> www
</span><span class='line'><span class="nv">pm</span> <span class="o">=</span> static
</span><span class='line'><span class="nv">request_terminate_timeout</span> <span class="o">=</span> 0
</span><span class='line'><span class="nv">request_slowlog_timeout</span> <span class="o">=</span> 0s
</span><span class='line'><span class="nv">slowlog</span> <span class="o">=</span> log/<span class="nv">$pool</span>.log.slow
</span><span class='line'><span class="nv">rlimit_files</span> <span class="o">=</span> 51200
</span><span class='line'><span class="nv">rlimit_core</span> <span class="o">=</span> 0
</span><span class='line'><span class="nv">catch_workers_output</span> <span class="o">=</span> yes
</span><span class='line'>pm.max_requests <span class="o">=</span> 500
</span><span class='line'>listen.allowed_clients <span class="o">=</span> 127.0.0.1
</span><span class='line'>env<span class="o">[</span>HOSTNAME<span class="o">]</span> <span class="o">=</span> <span class="nv">$HOSTNAME</span>
</span><span class='line'>env<span class="o">[</span>PATH<span class="o">]</span> <span class="o">=</span> /usr/local/bin:/usr/bin:/bin
</span><span class='line'>env<span class="o">[</span>TMP<span class="o">]</span> <span class="o">=</span> /tmp
</span><span class='line'>env<span class="o">[</span>TMPDIR<span class="o">]</span> <span class="o">=</span> /tmp
</span><span class='line'>env<span class="o">[</span>TEMP<span class="o">]</span> <span class="o">=</span> /tmp
</span><span class='line'>env<span class="o">[</span>OSTYPE<span class="o">]</span> <span class="o">=</span> <span class="nv">$OSTYPE</span>
</span><span class='line'>env<span class="o">[</span>MACHTYPE<span class="o">]</span> <span class="o">=</span> <span class="nv">$MACHTYPE</span>
</span><span class='line'>env<span class="o">[</span>MALLOC_CHECK_<span class="o">]</span> <span class="o">=</span> 2
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>启动php-fpm：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/webserver/php/sbin/php-fpm
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置开机自动启动php-fpm:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/rc.local
</span><span class='line'>/usr/local/webserver/php/sbin/php-fpm
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>5.编译安装Nginx</strong>
首先编译安装Nginx所需的pcre库：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf pcre-8.12.tar.gz
</span><span class='line'><span class="nb">cd </span>pcre-8.12
</span><span class='line'>./configure
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>编译安装Nginx:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar zxvf nginx-1.0.5.tar.gz
</span><span class='line'><span class="nb">cd </span>nginx-1.0.5
</span><span class='line'>./configure –user<span class="o">=</span>www –group<span class="o">=</span>www –prefix<span class="o">=</span>/usr/local/webserver/nginx –with-http_stub_status_module –with-http_ssl_module
</span><span class='line'>make &amp;amp;&amp;amp; make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>创建Nginx日志目录:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p /data/log
</span><span class='line'>chmod +w /data/log
</span><span class='line'>chown -R www:www /data/log
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>修改Nginx配置文件:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user  www www;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;worker_processes 1;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;error_log  /data/log/nginx_error.log  crit;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;pid        /usr/local/webserver/nginx/nginx.pid;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;specifies-the-value-for-maximum-file-descriptors-that-can-be-opened-by-this-process&quot;</span>&gt;Specifies the value <span class="k">for </span>maximum file descriptors that can be opened by this process.&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;worker_rlimit_nofile 65535;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;events
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  use epoll;
</span><span class='line'>  worker_connections 65535;
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;http
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  include       mime.types;
</span><span class='line'>  default_type  application/octet-stream;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#charset  gb2312;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;server_names_hash_bucket_size 128;
</span><span class='line'>  large_client_header_buffers 4 32k;
</span><span class='line'>  client_header_buffer_size 32k;
</span><span class='line'>  client_max_body_size 8m;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sendfile on;
</span><span class='line'>  keepalive_timeout 10 10;
</span><span class='line'>  tcp_nopush on;
</span><span class='line'>  tcp_nodelay on;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fastcgi_connect_timeout 300;
</span><span class='line'>  fastcgi_send_timeout 300;
</span><span class='line'>  fastcgi_read_timeout 300;
</span><span class='line'>  fastcgi_buffer_size 32k;
</span><span class='line'>  fastcgi_buffers 4 32k;
</span><span class='line'>  fastcgi_busy_buffers_size 32k;
</span><span class='line'>  fastcgi_temp_file_write_size 32k;
</span><span class='line'>  fastcgi_intercept_errors on;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;gzip on;
</span><span class='line'>  gzip_min_length  1k;
</span><span class='line'>  gzip_buffers     4 16k;
</span><span class='line'>  gzip_http_version 1.0;
</span><span class='line'>  gzip_comp_level 1;
</span><span class='line'>  gzip_types       text/plain application/x-javascript text/css application/xml;
</span><span class='line'>  gzip_vary on;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#limit_zone  crawler  <span class="nv">$binary_remote_addr</span>  10m;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;server
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    listen       80;
</span><span class='line'>    server_name  liuxuan.info www.liuxuan.info;
</span><span class='line'>    index index.html index.htm index.php;
</span><span class='line'>    root  /data/htdocs/blog;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;#limit_conn   crawler  20;
</span><span class='line'>
</span><span class='line'>location / <span class="o">{</span>
</span><span class='line'>   try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /index.php?q<span class="o">=</span><span class="nv">$uri</span>&amp;amp;<span class="nv">$args</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># if file exists return it right away</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span>-f <span class="nv">$request_filename</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="nb">break</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># otherwise rewrite the request</span>
</span><span class='line'><span class="k">if</span> <span class="o">(</span>!-e <span class="nv">$request_filename</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   rewrite ^<span class="o">(</span>.+<span class="o">)</span><span class="nv">$ </span>/index.php<span class="nv">$1</span> last;
</span><span class='line'>   <span class="nb">break</span>;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>location ~ .*<span class="se">\.</span><span class="o">(</span>php|php5<span class="o">)</span>?<span class="err">$</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  fastcgi_pass  unix:/tmp/php-cgi.sock;
</span><span class='line'>  <span class="c">#fastcgi_pass  127.0.0.1:9000;</span>
</span><span class='line'>  fastcgi_index index.php;
</span><span class='line'>  include fastcgi.conf;
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>location ~ .*<span class="se">\.</span><span class="o">(</span>gif|jpg|jpeg|png|bmp|swf<span class="o">)</span><span class="err">$</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  access_log off;
</span><span class='line'>  expires      30d;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>location ~ .*<span class="se">\.</span><span class="o">(</span>js|css<span class="o">)</span>?<span class="err">$</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  access_log off;
</span><span class='line'>  expires      1d;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Only allow search engine to access pics</span>
</span><span class='line'>location ~ .*<span class="se">\.</span><span class="o">(</span>gif|jpg|jpeg|png|bmp|swf|flv<span class="o">)</span><span class="err">$</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>valid_referers none blocked *.liuxuan.info *.google.com *.baidu.com;
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="nv">$invalid_referer</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="k">return </span>403;
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>log_format  access  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>          <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>          <span class="s1">&#39;&quot;$http_user_agent&quot; $http_x_forwarded_for&#39;</span>;
</span><span class='line'>access_log  /data/log/access.log  access;   <span class="o">}</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>检查Nginx配置是否正确：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/webserver/nginx/sbin/nginx -t
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>启动Nginx：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/webserver/nginx/sbin/nginx
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>配置开机自动启动Nginx：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /etc/rc.local
</span><span class='line'>/usr/local/webserver/nginx/sbin/nginx
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在不停止Nginx服务的情况下平滑变更Nginx配置：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">kill</span> -HUP &lt;code&gt;cat /usr/local/webserver/nginx/nginx.pid&lt;/code&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>6.Linux设置：</strong></p>

<p>修改服务器时间为上海时间：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>关闭不需要的服务：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ntsysv  //按空格选择和取消，按F12退出
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>以下仅列出需要启动的服务，未列出的服务一律关闭：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>crond
</span><span class='line'>iptables
</span><span class='line'>network
</span><span class='line'>syslog
</span><span class='line'>vsftpd
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><strong>四.总结</strong></p>

<p>回顾这段搭建的过程可谓历经挫折和痛苦，其中碰到了很多问题，为此我还到StackOverflow上发贴求助，但是我还是坚持了下来，直到搭建成功，所以说坚持和永不放弃的精神是非常重要的。搭建完成后，通过top命令发现虽然只有19个进程，但是内存占用还是蛮高的，特别是系统启动后需要占用的内存。好了，希望能给看到这篇博文的朋友带来帮助，缩短他们搭建的时间。</p>

<p>参考文章：</p>

<p>[1] <a href="http://blog.s135.com/nginx_php_v6/" title="http://blog.s135.com/nginx_php_v6/">http://blog.s135.com/nginx_php_v6/</a><br />
[2] <a href="http://www.fallday.org/archives/551" title="http://www.fallday.org/archives/551">http://www.fallday.org/archives/551</a></p>

]]></content>
  </entry>
  
</feed>
